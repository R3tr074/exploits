from web3 import Web3
import json

"""
Private key     :  0xd3af7a0070f21cb022224322361b0dfb26891288e5c9ae57c2de251c6462fdbc
Address         :  0x838D996a04F6Ba2EC943E81369618D68CDAEe01a
Target contract :  0x3f44BD8c161F9a4745ef4B358a181104E7588FD4
Setup contract  :  0x286B0cEac445Dd039e4633DEbB45b95E18A08E61
"""
priv_key = '0xd3af7a0070f21cb022224322361b0dfb26891288e5c9ae57c2de251c6462fdbc'
self_addr = '0x838D996a04F6Ba2EC943E81369618D68CDAEe01a'
setup_contract_addr = '0x286B0cEac445Dd039e4633DEbB45b95E18A08E61'
shooting_contract_addr = '0x3f44BD8c161F9a4745ef4B358a181104E7588FD4'

rpc_url = 'http://165.232.98.21:31888'
w3 = Web3(Web3.HTTPProvider(rpc_url))
if not w3.is_connected():
    print("[-] error to connect")
    exit(-1)
print('[+] Connected')

balance = w3.eth.get_balance(self_addr)
print("[*] My balance:", w3.from_wei(balance, 'ether'))

with open('./setup_abi.json') as f:
    setup_abi = json.load(f)
with open('./shootingArea_abi.json') as f:
    shooting_abi = json.load(f)

shooting_contract = w3.eth.contract(shooting_contract_addr, abi=shooting_abi)
setup_contract = w3.eth.contract(setup_contract_addr, abi=setup_abi)
nonce = w3.eth.get_transaction_count(self_addr)

# Call the "fallback" function
tx = {
    'to': shooting_contract_addr,
    'from': self_addr,
    'value': w3.to_wei(0.2, 'ether'),
    'data': '0x64656164',
    'nonce': nonce,
    'gas': w3.eth.estimate_gas(),
    'gasPrice': w3.eth.generate_gas_price()
}
signed_tx = w3.eth.account.sign_transaction(tx, private_key=priv_key)
send_tx = w3.eth.send_raw_transaction(signed_tx.rawTransaction)
receipt = w3.eth.wait_for_transaction_receipt(send_tx)

first_shot = shooting_contract.functions.firstShot().call()

# Call the "receive" function
del tx['data']
tx['nonce'] = w3.eth.get_transaction_count(self_addr)
signed_tx = w3.eth.account.sign_transaction(tx, private_key=priv_key)
send_tx = w3.eth.send_raw_transaction(signed_tx.rawTransaction)
receipt = w3.eth.wait_for_transaction_receipt(send_tx)

second_shot = shooting_contract.functions.secondShot().call()

# Call the "third" function
tx_hash = shooting_contract.functions.third().transact()
receipt = w3.eth.wait_for_transaction_receipt(tx_hash)

third_shot = shooting_contract.functions.thirdShot().call()

print('First Shot:', first_shot)
print('Second Shot:', second_shot)
print('Third Shot:', third_shot)

is_solved = setup_contract.functions.isSolved().call()
print("Win:", is_solved)
